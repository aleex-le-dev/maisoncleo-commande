#
# .htaccess pour application SPA (Vite) sous Apache
# - Fallback HTML5 History API -> index.html
# - Caching agressif des assets fingerprintés
# - Désactivation du cache sur index.html
# - Compression (si modules activés)
# - En-têtes de sécurité de base
# - Protection fichiers sensibles et dotfiles
#

DirectoryIndex index.html

# Forcer HTTPS (o2switch guide)
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{HTTP:X-Forwarded-Proto} !https
  RewriteCond %{HTTPS} !on
  RewriteRule ^(.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Empêcher l'indexation de répertoires
Options -Indexes

<IfModule mod_rewrite.c>
  RewriteEngine On

  # Conserver le prefix si l'app est servie depuis un sous-répertoire
  # RewriteBase /

  # Ne pas réécrire si fichier ou dossier existe
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # SPA fallback -> index.html
  RewriteRule ^ index.html [L]
</IfModule>

# Compression Gzip/Brotli si disponible
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>

# Caching
<IfModule mod_headers.c>
  # Cache long sur assets fingerprintés (Vite émet des noms avec hash)
  <FilesMatch "\.(?:js|mjs|css|png|jpg|jpeg|gif|svg|ico|webp|avif|woff|woff2|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Pas de cache sur index.html (toujours la version la plus récente)
  <FilesMatch "^index\.html$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
  </FilesMatch>

  # Compression: indiquer la variation selon l'encodage
  Header append Vary Accept-Encoding

  # En-têtes de sécurité raisonnables (compatibles SPA)
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

  # HSTS uniquement si HTTPS (Apache 2.4+)
  <If "%{HTTPS} == 'on'">
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    # Upgrade des contenus mixtes
    Header always set Content-Security-Policy "upgrade-insecure-requests"
  </If>
</IfModule>

# Protéger fichiers sensibles et dotfiles
<FilesMatch "^(\.env|\.git|\.husky|package-lock\.json|package\.json|vite\.config\.(js|ts))$">
  Require all denied
</FilesMatch>
<Files ".*">
  Require all denied
</Files>


