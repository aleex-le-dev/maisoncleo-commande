<IfModule mod_rewrite.c>
RewriteEngine On
Options -MultiViews

# Force HTTPS (gère aussi les reverse proxies)
RewriteCond %{HTTP:X-Forwarded-Proto} !https [OR]
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Ne pas réécrire si le fichier ou dossier existe
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule - [L]

# Ne pas réécrire pour les assets et fichiers statiques
RewriteCond %{REQUEST_URI} ^/(assets|favicon\.ico|robots\.txt|logo-mc-blanc\.png|mclogosite\.png) [NC,OR]
RewriteCond %{REQUEST_URI} \.(css|js|png|jpe?g|gif|webp|svg|ico|txt|map)$ [NC]
RewriteRule - [L]

# Fallback SPA vers index.html (uniquement si ce n'est pas un fichier/dossier)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]
</IfModule>

<IfModule mod_headers.c>
# En-têtes de sécurité
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "DENY"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "no-referrer-when-downgrade"
Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
Header always set Content-Security-Policy "upgrade-insecure-requests"

# HSTS uniquement si HTTPS actif
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS

# No-cache pour HTML
<FilesMatch "\.(html)$">
  Header set Cache-Control "no-cache, no-store, must-revalidate"
  Header set Pragma "no-cache"
  Header set Expires "0"
  FileETag None
</FilesMatch>

# Cache long pour assets fingerprintés
<FilesMatch "\.(js|css|png|jpe?g|gif|webp|svg|ico|map)$">
  Header set Cache-Control "public, max-age=31536000, immutable"
</FilesMatch>
</IfModule>

# Compression si disponible
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json image/svg+xml
</IfModule>

# Types MIME explicites pour JS/CSS
AddType application/javascript .js
AddType application/javascript .mjs
AddType text/css .css


